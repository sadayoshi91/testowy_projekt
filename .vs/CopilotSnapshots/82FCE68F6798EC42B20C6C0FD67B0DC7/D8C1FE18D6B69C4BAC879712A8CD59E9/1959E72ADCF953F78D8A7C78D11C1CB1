// src/app/components/ProjectDetails.tsx
import React from 'react';
import { Employee } from '../../models/employee';
import { ProjectDetails } from './ProjectDetails';

export function ProjectDetails({
    project,
    employees,
    onAssignSpecific,
    onUnassignSpecific
}: {
    project: any | null,
    employees: Employee[],
    onAssignSpecific?: (projectId: string, employeeId: string) => void,
    onUnassignSpecific?: (projectId: string, employeeId: string) => void
}) {
    if (!project) {
        return <div style={{ padding: 12 }}>No project selected</div>;
    }

    // defensive access to numeric fields
    const effort = (typeof project.effort === 'number') ? project.effort : (project?.effort ? Number(project.effort) : 0);
    const progress = (typeof project.progress === 'number') ? project.progress : 0;
    const reward = (typeof project.reward === 'number') ? project.reward : (project?.reward ? Number(project.reward) : 0);
    const percent = effort > 0 ? Math.min(100, Math.round((progress / effort) * 10000) / 100) : 0;

    // safe lookup for breakdown fields (some projects may not have them)
    const work = project?.work ?? project?.breakdown ?? {};
    const design = (typeof work.design === 'number') ? work.design : (work.design ? Number(work.design) : 0);
    const development = (typeof work.development === 'number') ? work.development : (work.development ? Number(work.development) : 0);
    const testing = (typeof work.testing === 'number') ? work.testing : (work.testing ? Number(work.testing) : 0);

    // assignees: list of employee ids -> map to names
    const assigneeIds: string[] = Array.isArray(project.assignees) ? project.assignees : [];
    const assignees = assigneeIds.map(id => employees.find(e => e.id === id)).filter(Boolean) as Employee[];

    // select helper id for DOM select element
    const selId = `proj-assign-${project.id}`;

    return (
        <div style={{ padding: 12, borderRadius: 6, border: '1px solid #eee', background: '#fff' }}>
            <h4 style={{ marginTop: 0 }}>{project.name ?? 'Unnamed project'} <small style={{ color: '#666' }}>({project?.type ?? project?.requiredRoles?.join(',') ?? 'general'})</small></h4>
            <div style={{ marginBottom: 8 }}>{project.description ?? ''}</div>

            <div style={{ display: 'flex', gap: 12 }}>
                <div style={{ minWidth: 200 }}>
                    <div><strong>Design:</strong> {design}/{project?.designGoal ?? '—'}</div>
                    <div><strong>Development:</strong> {development}/{project?.developmentGoal ?? '—'}</div>
                    <div><strong>Testing:</strong> {testing}/{project?.testingGoal ?? '—'}</div>
                </div>

                <div style={{ minWidth: 160 }}>
                    <div><strong>Effort:</strong> {effort}</div>
                    <div><strong>Progress:</strong> {Math.round(progress * 100) / 100} ({percent}%)</div>
                    <div><strong>Reward:</strong> {reward}</div>
                </div>
            </div>

            <div style={{ marginTop: 12 }}>
                <strong>Assigned employees ({assignees.length}):</strong>
                <ul>
                    {assignees.length === 0 ? <li style={{ color: '#777' }}>No assignees</li> : assignees.map(a => (
                        <li key={a.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span>{a.name} <small style={{ color: '#666' }}>({a.role})</small></span>
                            <div>
                                {onUnassignSpecific ? (
                                    <button style={{ marginLeft: 8 }} onClick={() => onUnassignSpecific(project.id, a.id)}>Remove</button>
                                ) : null}
                            </div>
                        </li>
                    ))}
                </ul>
            </div>

            <div style={{ marginTop: 8 }}>
                <label htmlFor={selId} style={{ marginRight: 8 }}>Assign employee:</label>
                <select id={selId} defaultValue="">
                    <option value="">-- choose employee --</option>
                    {employees.map(emp => (
                        <option key={emp.id} value={emp.id}>{emp.name} ({emp.role}) - Prod {emp.productivity?.toFixed?.(2) ?? emp.productivity ?? '0'}</option>
                    ))}
                </select>
                <button style={{ marginLeft: 8 }} onClick={() => {
                    const sel = document.getElementById(selId) as HTMLSelectElement | null;
                    const val = sel?.value;
                    if (!val) {
                        alert('Choose an employee to assign');
                        return;
                    }
                    if (onAssignSpecific) onAssignSpecific(project.id, val);
                }}>Assign</button>
            </div>

        </div>
    );
}
